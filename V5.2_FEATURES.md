# Navis.js v5.2 Features

## Overview

v5.2 introduces real-time features: WebSocket support, Server-Sent Events (SSE), and database integration helpers.

## New Features

### 1. WebSocket Support

Full WebSocket server implementation for real-time bidirectional communication.

**Features:**
- WebSocket handshake handling
- Message broadcasting
- Connection/disconnection handlers
- Client management
- Frame parsing and creation

**Usage:**

```javascript
const { WebSocketServer } = require('navis.js');

const app = new NavisApp();
const server = app.listen(3000);

// Create WebSocket server
const wsServer = new WebSocketServer({
  path: '/ws',
});

wsServer.attach(server);

// Connection handler
wsServer.onConnection((client) => {
  console.log('Client connected:', client.id);
  client.send({ type: 'welcome', message: 'Connected' });
});

// Message handler
wsServer.on('*', (message, client) => {
  console.log('Message from', client.id, ':', message);
  
  // Echo back
  client.send({
    type: 'echo',
    data: message,
  });
});

// Broadcast to all clients
wsServer.broadcast({ type: 'announcement', message: 'Hello all!' });

// Disconnection handler
wsServer.onDisconnection((client) => {
  console.log('Client disconnected:', client.id);
});
```

### 2. Server-Sent Events (SSE)

Server-Sent Events for one-way real-time streaming to clients.

**Features:**
- SSE protocol implementation
- Event types
- Client management
- Automatic reconnection support
- Broadcasting

**Usage:**

```javascript
const { sse } = require('navis.js');

app.get('/events', sse(), (req, res) => {
  // Send initial event
  res.sse.send({ message: 'Connected' }, 'connection');

  // Send periodic updates
  let count = 0;
  const interval = setInterval(() => {
    count++;
    res.sse.send({
      timestamp: new Date().toISOString(),
      count,
    }, 'update');

    if (count >= 10) {
      clearInterval(interval);
      res.sse.close();
    }
  }, 1000);

  // Cleanup on disconnect
  req.on('close', () => {
    clearInterval(interval);
  });
});

// Client-side (browser):
// const eventSource = new EventSource('/events');
// eventSource.addEventListener('update', (e) => {
//   console.log(JSON.parse(e.data));
// });
```

### 3. Database Integration Helpers

Connection pooling and query helpers for PostgreSQL, MySQL, and MongoDB.

**Features:**
- Connection pooling
- Multiple database support (PostgreSQL, MySQL, MongoDB)
- Query helpers
- Connection management
- Health check integration

**Usage:**

```javascript
const { createPool } = require('navis.js');

// PostgreSQL (requires pg package)
const dbPool = createPool({
  type: 'postgres',
  connectionString: process.env.DATABASE_URL,
  maxConnections: 10,
});

await dbPool.connect();

// Execute query
const users = await dbPool.query('SELECT * FROM users WHERE id = $1', [123]);

// MySQL (requires mysql2 package)
const mysqlPool = createPool({
  type: 'mysql',
  connectionString: process.env.DATABASE_URL,
});

const rows = await mysqlPool.query('SELECT * FROM users WHERE id = ?', [123]);

// MongoDB (requires mongodb package)
const mongoPool = createPool({
  type: 'mongodb',
  connectionString: process.env.DATABASE_URL,
});

const docs = await mongoPool.query('users', [{ _id: '123' }]);

// Health check integration
const healthChecker = createHealthChecker({
  checks: {
    database: async () => await dbPool.ping(),
  },
});

// Cleanup
await dbPool.close();
```

## Complete Example

```javascript
const {
  NavisApp,
  WebSocketServer,
  sse,
  createPool,
  createHealthChecker,
} = require('navis.js');

const app = new NavisApp();

// Database
const dbPool = createPool({
  type: 'postgres',
  connectionString: process.env.DATABASE_URL,
});
await dbPool.connect();

// SSE endpoint
app.get('/events', sse(), (req, res) => {
  res.sse.send({ message: 'Connected' });
});

// WebSocket
const server = app.listen(3000);
const wsServer = new WebSocketServer({ path: '/ws' });
wsServer.attach(server);

wsServer.onConnection((client) => {
  client.send({ type: 'welcome' });
});

// Health checks
const healthChecker = createHealthChecker({
  checks: {
    database: async () => await dbPool.ping(),
  },
});
app.use(healthChecker.middleware());
```

## Examples

See `examples/v5.2-features-demo.js` for complete working examples.

## Dependencies

- **WebSocket**: Built-in (no dependencies)
- **SSE**: Built-in (no dependencies)
- **PostgreSQL**: `npm install pg`
- **MySQL**: `npm install mysql2`
- **MongoDB**: `npm install mongodb`

